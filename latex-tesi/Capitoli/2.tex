\chapter{Tor § Onion v2}
\label{chap:Capitolo2}

Nel 2002 viene presentata la rete Tor, diventata open source 2 anni dopo è l'implementazione più famosa di onion routing che porta alcuni miglioramenti sostanziali \\
Migliore segretezza del canale, nella versione originale un nodo poteva forzare altri onion router nel circuito a decriptare il traffico precedentemente registrato. La rete tor sfrutta una tecnica di circuiti telescopici in cui il client che genera il circuito crea chiavi di sessione di breve durata che quindi non potranno essere usate dai malintenzionati per decriptare il vecchio traffico \\
L'implementazione del proxy di applicazione attraverso lo standard SOCKS, consente alla maggior parte del traffico TCP di funzionare senza modifiche. Precedentemente era necessario implementare un proxy per ogni applicazione, era quindi necessario generare un circuito per ogni applicazione, con conseguente duplicazione di chiavi, in Tor invece il circuito viene generato a livello di TCP e più applicazioni possono sfruttarlo. Per garantire la non tracciabilità di un utente nello stesso stream dati usato da più applicazioni è stato implementato il meccanismo dei rotating circuits che genera ogni minuto un nuovo circuito se quello precedente non viene usato
\begin{itemize}
    \item Controllo di congestione, un sistema decentralizzato che sfrutta ack end-to-end per garantire l'anonimato
    \item Directory Server, nodi più fidati di altri che descrivono le informazioni di rete in maniera sicura e affidabile
    \item Politiche di uscita variabili, ogni nodo possiede delle politiche che specificano le connessioni consentite e rifiutate, fondamentale in una rete distribuita fatta da volontari
    \item Controllo di integrità end-to-end, viene eseguito un controllo di integrità nel momento in cui il pacchetto esce dalla rete per garantire che i contenuti non sono stati alterati
\end{itemize}
Tor, a differenza degli altri sistemi che implementano le Mix-Network di Chaum predilige la bassa latenza, il che rende la rete adatta all'utilizzo tramite un web browser, questo inoltre migliora l'usabilità di tor il che è un aspetto fondamentale dato che maggiori sono i nodi e più semplice garantire l'anonimato. \\
Tor non è completamente sicuro, infatti non filtra informazioni di privacy nel corpo del messaggio come invece avviene in altri sistemi come Privoxy o Anonymizer e non offre garanzie in caso di attacco end-to-end che concerne sia sorgente che destinazione
\cite{onionv2}

\newpage
\section{Obiettivi}
L'obiettivo principale della rete TOR è la creazione di una rete che possa rendere gli attacchi molto più complessi da portare a termine scoraggiando cosi ogni possibile hacker, da questo principio cardine sono derivati gli altri obiettivi, tra cui
\begin{itemize}
    \item Usabilità, ogni sistema che implementa le Mix Networks ha bisogno di utenti e quindi nodi per rendere la rete sicura. L'usabilità garantisce la sicurezza. Da questo derivano altri obiettivi come
    \begin{itemize}
        \item Basse latenze, determinate anche dal fatto che più applicazioni possono usare lo stesso circuito TCP senza doverne generare uno nuovo per ogni stream dati, questo consente di ridurre il delay causato dalla criptografia asimmetrica
        \item Essere implementabile con meno configurazioni possibili
        \item Essere multi piattaforma
    \end{itemize}
    \item Semplicità, la rete deve essere facile da comprendere, doveva essere usabile nel mondo reale e non doveva essere troppo costosa
\end{itemize}

\cite{ChaumMixes}
\section{Network Design}
A differenza di altri sistemi che usano una rete peer-to-peer, Tor è una \emph{overlay network}, questa scelta è derivata dalle possibili vulnerabilità di una rete basata sugli utenti, in particolare un attaccante potrebbe compromettere il traffico leggendo o manipolando i dati. \\
Una \emph{overlay network} è una rete virtuale creata sfruttando una rete fisica preesistente, infatti ogni onion router è rappresentato come un processo software che mantiene due tipi di chiavi \\
\begin{itemize}
    \item Chiave d'identità, una chiave di lunga durata usata per firmare i pacchetti garantendo agli altri nodi della rete l'autenticità del messaggio e delle informazioni contenute, tra cui indirizzo, bandwidth, exit policy ecc
    \item Chiave onion, una chiave di breve durata usata per decriptare le richieste all'interno dei circuiti utente
\end{itemize}
\par
Un elemento chiave della rete TOR sono le celle, tutto il traffico della rete passa attraverso pacchetti di dimensione fissa 512 bytes chiamati celle, come ogni tipo di pacchetto sono divisi in header e payload, l'header contiene l'identificativo del circuito e un comando che indica come gestire il payload. Il comando può essere \\
\begin{itemize}
    \item Padding per mantenere viva la connessione
    \item Create per creare un nuovo circuito
    \item Destroy per eliminare un circuito
\end{itemize}
Inoltre il tipo di comando definisce il tipo della cella
\begin{itemize}
    \item Control, non vengono inoltrati ma sono gestiti dal primo router che li riceve
    \item Relay, trasporta stream dati per cui ha necessità di un header aggiuntivo contenente lo streamID, checksum per il controllo di integrità, la dimensione del payload e un comando di relay
    \item Il comando di relay può essere 
    \item Begin per iniziare uno stream
    \item End per terminare uno stream
    \item Teardown per terminare uno stream in modo forzato, usato per quelli rotti
    \item Connected per rispondere al relay begin dell'OP, informandolo che lo stream è stato creato con successo
    \item Extend per estendere un circuito di un router 
    \item Truncate per eseguire un teardown di una parte del circuito
    \item Sendme usato per il controllo di congestione
    \item Drop 
\end{itemize}

L'utente per generare il circuito segue un processo di negoziazione incrementale:
\begin{enumerate}
    \item Come primo passo l'utente, in particolare l'Onion Proxy invia una richiesta relay create al primo nodo nel percorso scelto
    \item Avviene la condivisione della chiave simmetrica tramite l'handshake di Diffie-Hellman, la creazione dell'ID del circuito e di conseguenza la creazione della connessione con il primo nodo (R1)
    \item L'utente invia una richiesta relay extend indicando a R1 l'indirizzo del secondo nodo nel percorso scelto (R2), R1 inizia una connessione con R2 definendo un nuovo id e associando la connessione OP-R1 con la connessione R1-R2, OP e R2 non si conoscono a vicenda e comunicano solo tramite l'intermediario R1. In fine R1 invia all'utente le informazioni del nuovo nodo tra cui la chiave simmetrica per il relativo strato
    \item Questa operazione viene effettuata, richiedendo all'ultimo router corrente di creare una connessione con il suo successivo, finché il circuito non viene completato\cite{ChaumMixes}
\end{enumerate}
\par
Ogni applicazione, in base alle proprie necessità, invia le richieste di stream TCP all'Onion Proxy, che sceglie il circuito più recente (oppure genera un nuovo circuito) e sceglie un exit node, solitamente l'ultimo router. A questo punto l'OP invia una cella \emph{relay begin} con un identificativo casuale all'exit node, la risposta dell'exit node conferma l'esistenza del nuovo stream TCP e l'OP può accettare i dati delle applicazioni TCP ed inoltrarli nella rete Onion \\
Questo design ha qualche problema derivato dal fatto che più OP potrebbero scegliere lo stesso percorso OR-OR, generando un bottleneck e saturando la rete. Le normali tecnologie di controllo di congestione non possono funzionare in una rete del genere, i pacchetti devono rispettare il proprio percorso e non possono cambiarlo, questo ne renderebbe impossibile la lettura. Per implementare un sistema di controllo di congestione sono stati implementati 2 meccanismi
\begin{itemize}
    \item \textbf{Controllo di Circuito}, ogni OP possiede le informazioni di entrambe le finestre per ogni OR, mentre ogni OR possiede le informazioni delle finestre del relativo OP per ogni circuito. Le finestre iniziano da un valore di 1000 e decrementano a ogni cella, sono
    \begin{itemize}
        \item \textbf{Packaging window}, tiene traccia del numero di celle un OR può inviare verso l'OP, quando un router riceve abbastanza celle dati (100) invia un relay sendme all'OP con $streamID = 0$, il quale incrementa la finestra per il relativo OR, se la finestra raggiunge 0 il router smette di ricevere celle dal circuito attendendo il sendme. Lo stesso meccanismo vale per l'OP
        \item \textbf{Delivery window}, tiene traccia del numero di celle un OR è in grado di inviare fuori dalla rete
    \end{itemize}
    \item \textbf{Controllo di Stream}, simile al controllo di circuito ma il meccanismo è applicato ad ogni stream TCP separatamente. Ogni stream inizia con packaging = 500 con incrementi di 50 ad ogni relay sendme
    % TODO sezione 4.6 Implementare la seguente scritta “invece di inviare un relay sendme dopo un determinato numero di celle ma…”
\end{itemize}

\newpage
\section{Directory Servers}
I directory server sono un piccolo sottogruppo di onion router utilizzati per tracciare i cambiamenti nella topologia di rete. In particolare un directory server agisce come un server HTTP accessibile dai client per ottenere lo stato della rete e la lista dei router aggiornata periodicamente dagli stessi OR. Il software di accesso alla rete onion è precaricato con le informazioni sui directory server e le relative chiavi \\
Quando il directory server riceve un aggiornamento da un OR prima di tutto controlla la chiave d'identità del router, garantendo che un attaccante non possa fingersi un OR manomettendo la rete \cite{ChaumMixes}
\section{Vulnerabilità} %Qui si parla delle vulnerabilità di onion v2 per cui si è passati a v3
Una delle maggiori vulnerabilità della rete tor è la possibilità per un servizio web di creare un codice JavaScript eseguito sul browser dell'utente che è in grado di ottenere informazioni sull'indirizzo dell'utente deanonimizzandolo. Gli sviluppatori di Tor hanno inserito appositamente un sistema di sicurezza nel browser che blocca ogni script di default

\section{Tor Browser}
% TODO parla dei tor relay in maniera più specifica